# AOT Tests Workflow with Caching for Performance
name: AOT Tests

on: [pull_request]

jobs:
  aot_test:
    runs-on: ubuntu-latest # You can try 'ubuntu-22.04' for a slightly more recent base

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # New Step: Cache Docker layers
      # This step checks for an existing cache of Docker layers and restores it.
      # If a cache is not found, it creates a new one after the build step.
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.docker/test-aot/
          key: ${{ runner.os }}-docker-${{ hashFiles('docker-compose.yml', '**/Dockerfile') }}
          restore-keys: |
            ${{ runner.os }}-docker-

      - name: Build the specific test service image
        # Using a shared cache directory for the build to enable layer caching
        run: docker compose build test-aot --build-arg BUILDKIT_INLINE_CACHE=1

      - name: Run AOT tests
        run: docker compose up --no-build --exit-code-from test-aot test-aot
